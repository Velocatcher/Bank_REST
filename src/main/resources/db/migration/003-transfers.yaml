# TRANSFERS с FK/индексом и откатами
databaseChangeLog:
  - changeSet:
      id: 003-transfers
      author: cc
      preConditions:
        onFail: MARK_RAN
        not:
          tableExists:
            tableName: transfers
      changes:
        - createTable:
            tableName: transfers
            columns:
              - column: { name: id, type: BIGINT, autoIncrement: true, constraints: { primaryKey: true, nullable: false } }
              - column: { name: from_card_id, type: BIGINT, constraints: { nullable: false } }
              - column: { name: to_card_id, type: BIGINT, constraints: { nullable: false } }
              - column: { name: user_id, type: BIGINT, constraints: { nullable: false } }
              - column: { name: amount, type: "DECIMAL(19,2)", constraints: { nullable: false } }
              - column: { name: created_at, type: DATETIME, constraints: { nullable: false } }

        - addForeignKeyConstraint:
            baseTableName: transfers
            baseColumnNames: from_card_id
            referencedTableName: cards
            referencedColumnNames: id
            onDelete: RESTRICT
            constraintName: fk_transfers_from_card_id   # <-- добавили имя

        - addForeignKeyConstraint:
            baseTableName: transfers
            baseColumnNames: to_card_id
            referencedTableName: cards
            referencedColumnNames: id
            onDelete: RESTRICT
            constraintName: fk_transfers_to_card_id     # <-- добавили имя

        - addForeignKeyConstraint:
            baseTableName: transfers
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            onDelete: RESTRICT
            constraintName: fk_transfers_user_id        # <-- добавили имя

        - createIndex:
            tableName: transfers
            indexName: ix_transfers_user_created
            columns:
              - column: { name: user_id }
              - column: { name: created_at }

      rollback:
        - dropIndex: { indexName: ix_transfers_user_created, tableName: transfers }
        - dropForeignKeyConstraint: { baseTableName: transfers, constraintName: fk_transfers_user_id }
        - dropForeignKeyConstraint: { baseTableName: transfers, constraintName: fk_transfers_to_card_id }
        - dropForeignKeyConstraint: { baseTableName: transfers, constraintName: fk_transfers_from_card_id }
        - dropTable: { tableName: transfers }
