# USERS + USER_ROLES (MySQL) с откатами
databaseChangeLog:
  - changeSet:
      id: 001-users
      author: cc
      preConditions:
        onFail: MARK_RAN
        not:
          tableExists:
            tableName: users
      changes:
        - createTable:
            tableName: users
            columns:
              - column: { name: id, type: BIGINT, autoIncrement: true, constraints: { primaryKey: true, nullable: false } }
              - column: { name: username, type: "VARCHAR(64)", constraints: { nullable: false, unique: true } }
              - column: { name: password, type: "VARCHAR(255)", constraints: { nullable: false } }

        - createTable:
            tableName: user_roles
            columns:
              - column: { name: user_id, type: BIGINT, constraints: { nullable: false } }
              - column: { name: role, type: "VARCHAR(16)", constraints: { nullable: false } }

        - addForeignKeyConstraint:
            baseTableName: user_roles
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_user_roles_user_id   # <-- добавили имя

        - createIndex:
            tableName: user_roles
            indexName: ix_user_roles_user
            columns:
              - column: { name: user_id }

        - createIndex:
            tableName: user_roles
            indexName: ix_user_roles_role
            columns:
              - column: { name: role }

      rollback:
        - dropIndex: { indexName: ix_user_roles_role, tableName: user_roles }
        - dropIndex: { indexName: ix_user_roles_user, tableName: user_roles }
        - dropForeignKeyConstraint: { baseTableName: user_roles, constraintName: fk_user_roles_user_id }
        - dropTable: { tableName: user_roles }
        - dropTable: { tableName: users }
